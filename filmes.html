<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Filmes Estranhos</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1>Filmes Estranhos</h1>
  <button onclick="logout()">Sair</button>
</header>

<main>
  <div id="add-area" class="add-form">
    <input type="text" id="titulo" placeholder="Título do Filme" />
    <input type="text" id="ano" placeholder="Ano (opcional)" />
    <button onclick="adicionarFilme()">Adicionar Filme</button>
  </div>

  <div id="filmes" class="filmes-grid"></div>
</main>

<script>
const apiSheet = 'https://sheetdb.io/api/v1/dlats2maboyum';
const apiOMDb = 'https://www.omdbapi.com/?apikey=6cbfb854';

const usuarioLogado = localStorage.getItem('usuarioLogado');
const admin = usuarioLogado === 'ppomaster';

if (!usuarioLogado) window.location.href = 'login.html';

if (!admin) document.getElementById('add-area').style.display = 'none';

async function carregarFilmes() {
  const res = await fetch(apiSheet);
  const dados = await res.json();
  const container = document.getElementById('filmes');
  container.innerHTML = '';

  dados.forEach(filme => {
    const card = document.createElement('div');
    card.className = 'filme';

    card.innerHTML = `
      <img src="${filme.Poster}" alt="${filme.Titulo}" onclick="abrirDetalhes('${filme.Titulo}')" />
      <h3>${filme.Titulo} (${filme.Ano})</h3>
      <p>${filme.Sinopse}</p>
      ${admin ? `<button onclick="excluirFilme('${filme.Titulo}')">Excluir</button>` : ''}
    `;
    container.appendChild(card);
  });
}

async function adicionarFilme() {
  const titulo = document.getElementById('titulo').value.trim();
  const ano = document.getElementById('ano').value.trim();

  if (!titulo) {
    alert('Digite o título do filme');
    return;
  }

  try {
    const busca = await fetch(`${apiOMDb}&t=${encodeURIComponent(titulo)}${ano ? `&y=${ano}` : ''}`);
    const dados = await busca.json();

    if (dados.Response === 'False') {
      alert('Filme não encontrado na OMDb');
      return;
    }

    const filme = {
      Titulo: dados.Title,
      Ano: dados.Year,
      Poster: dados.Poster !== 'N/A' ? dados.Poster : 'sem-poster.jpg',
      Sinopse: dados.Plot !== 'N/A' ? dados.Plot : 'Sinopse não disponível'
    };

    await fetch(apiSheet, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: filme })
    });

    document.getElementById('titulo').value = '';
    document.getElementById('ano').value = '';
    carregarFilmes();

  } catch (error) {
    alert('Erro ao adicionar filme');
    console.error(error);
  }
}

async function excluirFilme(titulo) {
  if (!confirm(`Excluir o filme "${titulo}"?`)) return;

  await fetch(`${apiSheet}/Titulo/${encodeURIComponent(titulo)}`, {
    method: 'DELETE'
  });
  carregarFilmes();
}

function abrirDetalhes(titulo) {
  window.location.href = `detalhes.html?t=${encodeURIComponent(titulo)}`;
}

function logout() {
  localStorage.removeItem('usuarioLogado');
  window.location.href = 'login.html';
}

carregarFilmes();
</script>

</body>
</html>